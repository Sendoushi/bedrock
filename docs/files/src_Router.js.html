<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Router.js - Bedrock</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">Bedrock: src/Router.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/Rock.html">Rock</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>src/<ul><li><a href="../files/src_Controller.js.html">Controller.js</a></li><li><a href="../files/src_Model.js.html">Model.js</a></li><li><a href="../files/src_Rock.js.html">Rock.js</a></li><li><a href="../files/src_Router.js.html">Router.js</a></li><li><a href="../files/src_View.js.html">View.js</a></li><li>utils/<ul><li><a href="../files/src_utils_logger.js.html">logger.js</a></li></ul></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>src/Router.js</h4>

<pre class="code prettyprint linenums">
define([
    &#x27;config&#x27;,
    &#x27;states&#x27;,
    &#x27;backbone&#x27;,
    &#x27;./Rock&#x27;,
    &#x27;underscore&#x27;
], function (config, states, Backbone, Rock, _) {

    &#x27;use strict&#x27;;

    return Backbone.Router.extend(_.extend({}, Rock, {
        cid: _.uniqueId(&#x27;router&#x27;),

        _name: &#x27;Router&#x27;,

        _routesOriginal: {
            &#x27;404&#x27;: &#x27;notFound&#x27;
        },

        routes: {},

        /**
         * Foundation router constructor
         */
        constructor: function (options) {
            // Build routes
            this._routesOriginal = _.extend(this._routesOriginal, states);
            _.each(this._routesOriginal, function (val, key) {
                this.routes[key] = this._stateManager.bind(this, val, key);
            }.bind(this));

            // Run the backbone constructor
            Backbone.Router.prototype.constructor.call(this, options);
        },

        /**
         * Bedrock router initialize
         */
        initialize: function () {
            Backbone.Router.prototype.initialize.apply(this, arguments);

            return this;
        },

        /**
         * Starts the router
         */
        start: function () {
            !this._siblings.length &amp;&amp; this._logger.warn(this._name, &#x27;There are no siblings. State won\&#x27;t be handled.&#x27;);

            // Listens for the changes
            var historyStart = Backbone.history.start({ pushState: true });

            // No history is 404
            !historyStart &amp;&amp; this.navigate(&#x27;404&#x27;, { trigger: true });
        },

        // -----------------------------------

        /**
         * Manages the states of the routes
         */
        _stateManager: function (state, route) {
            var routeArr,
                routeAdded,
                args,
                params,
                stateParsed,
                hasParams,
                paramsObj,
                i;

            // TODO: Support * and ? in the routes

            // Take care of routes besides the index one
            if (route !== &#x27;&#x27;) {
                routeArr = route.split(&#x27;/&#x27;);
                routeAdded = [];
                args = arguments;

                // Get all params
                i = 1;
                params = routeArr.map(function (val) {
                    // Check if there is a param in the route bit
                    if (val.replace(&#x27;:&#x27;, &#x27;&#x27;) === val) {
                        return;
                    }

                    i += 1;
                    return {
                        param: val.replace(&#x27;:&#x27;, &#x27;&#x27;),
                        value: args[i]
                    };
                }).filter(function (val) { return !!val; });

                // Build the routes added
                _.each(routeArr, function (val, i) {
                    routeAdded.push((i !== 0 &amp;&amp; (routeAdded[i - 1] + &#x27;/&#x27;) || &#x27;&#x27;) + routeArr[i]);
                });

                // Go through each from the child
                _.each(routeAdded.reverse(), function (routeUrl, i) {
                    // State may not exist
                    if (!this._routesOriginal[routeUrl]) {
                        return;
                    }

                    // Map to the right params
                    paramsObj = {};
                    hasParams = !!(params.map(function (val) {
                        // Check if there is a param in the route
                        if (routeUrl.replace(&#x27;:&#x27; + val.param, &#x27;&#x27;) === routeUrl) {
                            return false;
                        }

                        // Add the param
                        paramsObj[val.param] = val.value;

                        // Used later to see if there are params in the route
                        return true;
                    }).filter(function (val) { return val; }).length);

                    // Build the state object
                    stateParsed = {
                        name: this._routesOriginal[routeUrl],
                        route: routeUrl,
                        params: hasParams &amp;&amp; paramsObj || undefined,
                        child: stateParsed
                    };
                }.bind(this));
            }

            // Add the index
            stateParsed = {
                name: this._routesOriginal[&#x27;&#x27;],
                route: &#x27;&#x27;,
                child: stateParsed
            };

            // Handle state
            this._handleState(stateParsed);

        },

        /**
         * Handle state
         */
        _handleState: function (state) {
            !this._siblings.length &amp;&amp; this._logger.warn(this._name, &#x27;There are no siblings. State won\&#x27;t be handled.&#x27;);

            _.each(this._siblings, function (child) {
                child.setState(state);
            });

            // Finally trigger the statechange
            this.trigger(&#x27;statechange&#x27;, state);
        }
    }));
});

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
